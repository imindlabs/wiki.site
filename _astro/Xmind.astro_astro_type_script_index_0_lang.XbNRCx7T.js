class c{channel=new MessageChannel;channelSetupPromise;eventIndex=0;handlers={};constructor(e,n="*"){const t=e.getIframe();if(t.hasAttribute("data-event-channel-setup"))throw new Error("An embed viewer instance already initialized on the iframe!");t.setAttribute("data-event-channel-setup","true"),this.channelSetupPromise=(async()=>{await new Promise(s=>{t.addEventListener("load",()=>{this.channel.port1.start();const r=i=>{const[a]=i.data;a==="channel-ready"&&(i.preventDefault(),this.channel.port1.removeEventListener("message",r),this.channel.port1.addEventListener("message",this.eventDispatcher.bind(this)),s(void 0))};this.channel.port1.addEventListener("message",r),t.contentWindow?.postMessage(["setup-channel",{port:this.channel.port2}],n||"*",[this.channel.port2])})})})()}eventDispatcher(e){const[n,t,s]=e.data||[];n==="event"&&t&&this.handlers[t]&&this.handlers[t].forEach(r=>r(s))}addEventListener(e,n){this.handlers[e]=this.handlers[e]||[],!this.handlers[e].includes(n)&&this.handlers[e].push(n)}removeEventListener(e,n){if(!this.handlers[e])return;const t=this.handlers[e].findIndex(s=>s===n);this.handlers[e].splice(t,1)}async emit(e,n){await this.channelSetupPromise;const t=`xmind-embed-viewer#${this.eventIndex++}`;await new Promise(s=>{const r=i=>{const[a,h]=i.data;a===t&&(this.channel.port1.removeEventListener("message",r),s(h))};this.channel.port1.addEventListener("message",r),this.channel.port1.postMessage([e,n,t])})}}class m{iframe;constructor(e,n){let t;const s=typeof e=="string"?document.querySelector(e):e;if(s===null)throw new Error("IFrame or mount element not found by selector "+e);s instanceof HTMLIFrameElement?t=s:(t=document.createElement("iframe"),s.appendChild(t)),t.setAttribute("frameborder","0"),t.setAttribute("scrolling","no"),t.setAttribute("allowfullscreen","true"),t.setAttribute("allow","allowfullscreen"),t.setAttribute("crossorigin","anonymous"),t.setAttribute("src",n),this.iframe=t}getIframe(){return this.iframe}setStyles(e){const n=this.getIframe();for(const[t,s]of Object.entries(e))n.style[t]=s}}class f{iframeController;iframeEventChannelController;internalState={sheets:[],zoomScale:100,currentSheetId:""};region;constructor(e){const{file:n,el:t,region:s="global",styles:r={height:"350px",width:"750px"},isPitchModeDisabled:i}=e,a=s==="cn"?"www.xmind.cn":"www.xmind.app",h=new m(t,`https://${a}/embed-viewer${i?"?pitch-mode=disabled":""}`),d=new c(h,`https://${a}`);this.iframeController=h,this.iframeEventChannelController=d,this.region=s,d.addEventListener("sheet-switch",o=>this.internalState.currentSheetId=o),d.addEventListener("zoom-change",o=>this.internalState.zoomScale=o),d.addEventListener("sheets-load",o=>this.internalState.sheets=o),this.iframeController.setStyles(r),n&&this.load(n)}addEventListener(e,n){this.iframeEventChannelController.addEventListener(e,n)}removeEventListener(e,n){this.iframeEventChannelController.removeEventListener(e,n)}setStyles(e){this.iframeController.setStyles(e)}load(e){this.iframeEventChannelController.emit("open-file",e)}setZoomScale(e){this.iframeEventChannelController.emit("zoom",e)}setFitMap(){this.iframeEventChannelController.emit("fit-map")}switchSheet(e){this.iframeEventChannelController.emit("switch-sheet",e)}get zoom(){return this.internalState.zoomScale}get sheets(){return JSON.parse(JSON.stringify(this.internalState.sheets))}get currentSheetId(){return this.internalState.currentSheetId}}function u(l,e,n){(async()=>{var s=await fetch(l),r=new f({el:e,file:await s.arrayBuffer(),region:"global",styles:{height:"500px",width:"100%"}});n&&r.addEventListener("map-ready",()=>r.setZoomScale(n))})()}class p extends HTMLElement{connectedCallback(){const e=this.id,n=this.dataset.uri,t=this.dataset.zoomScale;u(n,`#${e}`,t)}}customElements.define("xmind-render",p);
